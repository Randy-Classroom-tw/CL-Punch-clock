<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>檔案上傳系統 - 連接 Google Drive</title>
    
    <!-- 載入 Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    
    <!-- 載入 Font Awesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /**
         * 主要樣式定義
         * 針對檔案上傳系統的所有UI元素提供專用樣式
         */
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-color: #dee2e6;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }
        
        body {
            background-color: var(--light-color);
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            padding-bottom: 50px;
        }
        
        .page-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .header-section h1 {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header-section p {
            color: #6c757d;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .main-card {
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .api-config-section {
            padding: 20px;
            background-color: rgba(13, 110, 253, 0.05);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 1px solid rgba(13, 110, 253, 0.2);
        }
        
        .api-config-section h3 {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .api-input-group {
            margin-bottom: 15px;
        }
        
        /* 拖放區域樣式 */
        .drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 50px 20px;
            text-align: center;
            transition: all var(--transition-speed) ease;
            background-color: var(--light-color);
            position: relative;
            cursor: pointer;
        }
        
        .drop-zone.highlight {
            border-color: var(--primary-color);
            background-color: rgba(13, 110, 253, 0.1);
        }
        
        .drop-zone i.main-icon {
            font-size: 60px;
            color: #6c757d;
            margin-bottom: 15px;
            transition: all var(--transition-speed) ease;
        }
        
        .drop-zone:hover i.main-icon {
            color: var(--primary-color);
        }
        
        .drop-zone h3 {
            font-size: 22px;
            color: var(--dark-color);
            margin-bottom: 10px;
        }
        
        .drop-zone p {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        /* 檔案資訊顯示區域 */
        .file-info-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .file-info-container h4 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
        }
        
        .file-info-container h4 i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .file-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .file-info-item {
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .file-info-item .info-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        
        .file-info-item .info-value {
            word-break: break-all;
        }
        
        /* 進度顯示區域 */
        .progress-container {
            margin-top: 30px;
            display: none;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress {
            height: 25px;
            margin-bottom: 10px;
            border-radius: 50px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            border-radius: 50px;
            transition: width 0.3s ease;
        }
        
        /* 上傳按鈕 */
        .upload-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color var(--transition-speed);
            position: relative;
        }
        
        .upload-btn:hover {
            background-color: #157347;
        }
        
        .upload-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .upload-btn i {
            margin-right: 10px;
        }
        
        /* 狀態提示訊息 */
        .status-alert {
            margin-top: 20px;
            display: none;
            border-radius: 8px;
        }
        
        /* 結果顯示區域 */
        .result-section {
            margin-top: 30px;
            display: none;
        }
        
        .result-section .card {
            border-left: 5px solid var(--success-color);
        }
        
        .result-link {
            display: inline-flex;
            align-items: center;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .result-link:hover {
            text-decoration: underline;
        }
        
        .result-link i {
            margin-right: 5px;
        }
        
        /* 載入指示器 */
        .loader-container {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 上傳歷史記錄區域 */
        .history-section {
            margin-top: 40px;
        }
        
        .history-section h3 {
            margin-bottom: 20px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
        }
        
        .history-section h3 i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .history-empty {
            text-align: center;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            color: #6c757d;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th,
        .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-table th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
        }
        
        .history-table tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .history-table .file-link {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .history-table .file-link:hover {
            text-decoration: underline;
        }
        
        /* 頁尾版權資訊 */
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* 響應式設計調整 */
        @media (max-width: 768px) {
            .file-info-grid {
                grid-template-columns: 1fr;
            }
            
            .main-card {
                padding: 20px;
            }
            
            .drop-zone {
                padding: 30px 15px;
            }
            
            .drop-zone i.main-icon {
                font-size: 50px;
            }
            
            .drop-zone h3 {
                font-size: 18px;
            }
            
            .history-table th:nth-child(3),
            .history-table td:nth-child(3) {
                display: none;
            }
        }
        
        @media (max-width: 576px) {
            .history-table th:nth-child(4),
            .history-table td:nth-child(4) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- 頁頭區塊 -->
        <div class="header-section">
            <h1><i class="fas fa-cloud-upload-alt"></i> 檔案上傳系統</h1>
            <p>安全地將檔案上傳至 Google Drive 指定資料夾</p>
        </div>
        
        <!-- 主要操作區塊 -->
        <div class="main-card">
            <!-- API 設定區塊 -->
            <div class="api-config-section">
                <h3><i class="fas fa-cog"></i> API 設定</h3>
                <div class="api-input-group">
                    <label for="api-url" class="form-label">Google Apps Script 網址:</label>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="api-url" 
                            class="form-control" 
                            value="https://script.google.com/macros/s/AKfycbyXPv6OTGrPggsk4wg9Ow1uxXSf_Df-GWqYCBIps1ZTSMLCHc0bsfIHq3ab6S1fGSJ8ng/exec" 
                            readonly
                        >
                        <button class="btn btn-outline-secondary" type="button" id="edit-api-url-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-primary" type="button" id="save-api-url-btn" style="display: none;">
                            <i class="fas fa-save"></i> 儲存
                        </button>
                    </div>
                    <div class="form-text">此為系統與 Google Drive 連接的 API 端點</div>
                </div>
                <div class="api-status" id="api-status">
                    <span class="badge bg-secondary">尚未連接</span>
                </div>
            </div>
            
            <!-- 檔案上傳區塊 -->
            <div id="drop-zone" class="drop-zone">
                <i class="fas fa-file-upload main-icon"></i>
                <h3>拖放檔案至此區域</h3>
                <p>或者點擊此處選擇檔案</p>
                <span class="btn btn-primary select-file-btn">選擇檔案</span>
                <input type="file" id="file-input" class="file-input">
            </div>
            
            <!-- 檔案資訊顯示區塊 -->
            <div id="file-info-container" class="file-info-container">
                <h4><i class="fas fa-file-alt"></i> 檔案資訊</h4>
                <div class="file-info-grid">
                    <div class="file-info-item">
                        <div class="info-label">檔案名稱</div>
                        <div class="info-value" id="file-name">-</div>
                    </div>
                    <div class="file-info-item">
                        <div class="info-label">檔案類型</div>
                        <div class="info-value" id="file-type">-</div>
                    </div>
                    <div class="file-info-item">
                        <div class="info-label">檔案大小</div>
                        <div class="info-value" id="file-size">-</div>
                    </div>
                    <div class="file-info-item">
                        <div class="info-label">最後修改</div>
                        <div class="info-value" id="file-modified">-</div>
                    </div>
                </div>
            </div>
            
            <!-- 上傳進度顯示區塊 -->
            <div id="progress-container" class="progress-container">
                <div class="progress-label">
                    <span>上傳進度</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="progress">
                    <div 
                        id="progress-bar" 
                        class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                        role="progressbar" 
                        aria-valuenow="0" 
                        aria-valuemin="0" 
                        aria-valuemax="100" 
                        style="width: 0%">
                    </div>
                </div>
                <div class="text-center text-muted" id="upload-status-text">準備上傳中...</div>
            </div>
            
            <!-- 載入指示器 -->
            <div id="loader-container" class="loader-container">
                <div class="loader"></div>
                <p class="mt-2 text-muted">處理中，請稍候...</p>
            </div>
            
            <!-- 上傳按鈕 -->
            <button id="upload-btn" class="upload-btn" disabled>
                <i class="fas fa-cloud-upload-alt"></i> 上傳檔案
            </button>
            
            <!-- 狀態提示訊息 -->
            <div id="success-alert" class="alert alert-success status-alert" role="alert">
                <i class="fas fa-check-circle"></i> <span id="success-message"></span>
            </div>
            <div id="error-alert" class="alert alert-danger status-alert" role="alert">
                <i class="fas fa-exclamation-circle"></i> <span id="error-message"></span>
            </div>
            
            <!-- 上傳結果顯示區域 -->
            <div id="result-section" class="result-section">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-check-circle text-success"></i> 檔案上傳成功</h5>
                        <p class="card-text" id="result-text">您的檔案已成功上傳至 Google Drive。</p>
                        <a id="result-link" href="#" target="_blank" class="result-link">
                            <i class="fas fa-external-link-alt"></i> 在 Google Drive 中查看
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 上傳歷史記錄區塊 -->
        <div id="history-section" class="main-card history-section">
            <h3><i class="fas fa-history"></i> 上傳歷史記錄</h3>
            <div id="history-content">
                <div id="history-empty" class="history-empty">
                    <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                    <p>目前尚無上傳記錄</p>
                </div>
                <div id="history-table-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>上傳時間</th>
                                    <th>檔案名稱</th>
                                    <th>檔案類型</th>
                                    <th>檔案大小</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- 動態產生的歷史記錄將在此顯示 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button id="refresh-history-btn" class="btn btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> 重新整理記錄
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 頁尾版權資訊 -->
        <div class="footer">
            <p>&copy; 2025 檔案上傳系統 | 使用 GitHub Pages 與 Google Apps Script</p>
        </div>
    </div>
    
    <!-- 載入 Bootstrap 5 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- 主要應用程式邏輯 -->
    <script>
        /**
         * 檔案上傳系統 - 前端應用程式 (無iframe版本)
         * 
         * 此腳本實現與 Google Apps Script 通訊的檔案上傳功能
         * 使用JSONP和表單重定向來繞過CORS限制
         * 
         * @version 3.0.0
         * @author Claude
         * @date 2025-03-27
         */
        
        // 使用立即執行函數表達式 (IIFE) 建立模組化程式
        (function() {
            'use strict';
            
            /**
             * 應用程式配置
             * @type {Object}
             */
            const AppConfig = {
                // API 相關設定
                apiUrl: 'https://script.google.com/macros/s/AKfycbyXPv6OTGrPggsk4wg9Ow1uxXSf_Df-GWqYCBIps1ZTSMLCHc0bsfIHq3ab6S1fGSJ8ng/exec',
                
                // 檔案上傳限制
                maxFileSize: 50 * 1024 * 1024, // 50MB (Google Apps Script 限制)
                
                // 進度模擬設定
                progressSimulation: {
                    initialValue: 0,
                    maxSimulatedValue: 90,
                    incrementStep: 5,
                    intervalTime: 300 // 毫秒
                },
                
                // 提示訊息顯示持續時間
                alertDisplayTime: 5000, // 5秒
                
                // 本地儲存鍵名
                storageKeys: {
                    apiUrl: 'gas_api_url',
                    currentUpload: 'currentUpload'
                }
            };
            
            /**
             * 使用者介面元素參照
             * @type {Object}
             */
            const UI = {
                // API 相關元素
                apiUrlInput: document.getElementById('api-url'),
                editApiUrlBtn: document.getElementById('edit-api-url-btn'),
                saveApiUrlBtn: document.getElementById('save-api-url-btn'),
                apiStatus: document.getElementById('api-status'),
                
                // 檔案選擇和顯示元素
                dropZone: document.getElementById('drop-zone'),
                fileInput: document.getElementById('file-input'),
                fileInfoContainer: document.getElementById('file-info-container'),
                fileName: document.getElementById('file-name'),
                fileType: document.getElementById('file-type'),
                fileSize: document.getElementById('file-size'),
                fileModified: document.getElementById('file-modified'),
                
                // 上傳相關元素
                uploadBtn: document.getElementById('upload-btn'),
                progressContainer: document.getElementById('progress-container'),
                progressBar: document.getElementById('progress-bar'),
                progressPercentage: document.getElementById('progress-percentage'),
                uploadStatusText: document.getElementById('upload-status-text'),
                loaderContainer: document.getElementById('loader-container'),
                
                // 狀態和結果顯示元素
                successAlert: document.getElementById('success-alert'),
                errorAlert: document.getElementById('error-alert'),
                successMessage: document.getElementById('success-message'),
                errorMessage: document.getElementById('error-message'),
                resultSection: document.getElementById('result-section'),
                resultText: document.getElementById('result-text'),
                resultLink: document.getElementById('result-link'),
                
                // 歷史記錄相關元素
                historySection: document.getElementById('history-section'),
                historyEmpty: document.getElementById('history-empty'),
                historyTableContainer: document.getElementById('history-table-container'),
                historyTableBody: document.getElementById('history-table-body'),
                refreshHistoryBtn: document.getElementById('refresh-history-btn')
            };
            
            /**
             * 應用程式狀態
             * @type {Object}
             */
            const AppState = {
                // 目前選擇的檔案
                selectedFile: null,
                
                // 上傳進度模擬計時器
                progressInterval: null,
                
                // API 連接狀態
                apiConnected: false,
                
                // 上傳狀態
                isUploading: false,
                
                // 上傳結果檢查計時器
                uploadCheckTimer: null
            };
            
            /**
             * 初始化應用程式
             */
            function initializeApp() {
                console.log('初始化檔案上傳應用程式...');
                
                // 檢查URL參數，處理潛在的上傳重定向
                handleRedirectParams();
                
                // 載入已儲存的 API URL
                loadApiUrl();
                
                // 設定事件監聽
                setupEventListeners();
                
                // 驗證 API 連接
                checkApiConnection();
                
                // 載入上傳歷史記錄
                loadUploadHistory();
                
                console.log('應用程式初始化完成');
            }
            
            /**
             * 處理URL重定向參數
             */
            function handleRedirectParams() {
                const urlParams = new URLSearchParams(window.location.search);
                
                // 檢查上傳成功參數
                if (urlParams.get('upload_success') === 'true') {
                    // 獲取上傳ID
                    const uploadId = urlParams.get('id');
                    if (uploadId) {
                        // 從localStorage獲取上傳信息
                        const uploadInfo = JSON.parse(localStorage.getItem(AppConfig.storageKeys.currentUpload)) || {};
                        
                        if (uploadInfo.id === uploadId) {
                            // 清除URL參數
                            window.history.replaceState({}, document.title, window.location.pathname);
                            
                            // 獲取檔案URL
                            const fileUrl = urlParams.get('fileUrl') || '#';
                            
                            // 模擬上傳成功
                            setTimeout(() => {
                                handleUploadSuccess({
                                    success: true,
                                    fileName: uploadInfo.fileName,
                                    fileUrl: fileUrl,
                                    message: '檔案上傳成功',
                                    timestamp: new Date().toISOString()
                                });
                                
                                // 清除本地存儲
                                localStorage.removeItem(AppConfig.storageKeys.currentUpload);
                            }, 500);
                        }
                    }
                }
                
                // 檢查錯誤參數
                if (urlParams.get('error')) {
                    const errorMsg = urlParams.get('error');
                    
                    // 清除URL參數
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // 顯示錯誤信息
                    setTimeout(() => {
                        handleUploadError(decodeURIComponent(errorMsg));
                        
                        // 清除本地存儲
                        localStorage.removeItem(AppConfig.storageKeys.currentUpload);
                    }, 500);
                }
            }
            
            /**
             * 載入已儲存的 API URL
             */
            function loadApiUrl() {
                const savedUrl = localStorage.getItem(AppConfig.storageKeys.apiUrl);
                if (savedUrl) {
                    AppConfig.apiUrl = savedUrl;
                    UI.apiUrlInput.value = savedUrl;
                    console.log('已從本地儲存載入 API URL');
                }
            }
            
            /**
             * 設定所有事件監聽器
             */
            function setupEventListeners() {
                // API URL 編輯按鈕事件
                UI.editApiUrlBtn.addEventListener('click', handleEditApiUrl);
                UI.saveApiUrlBtn.addEventListener('click', handleSaveApiUrl);
                
                // 拖放區域事件
                setupDragAndDropEvents();
                
                // 檔案選擇事件
                UI.fileInput.addEventListener('change', handleFileSelect);
                
                // 上傳按鈕事件
                UI.uploadBtn.addEventListener('click', handleUpload);
                
                // 刷新歷史記錄按鈕事件
                UI.refreshHistoryBtn.addEventListener('click', loadUploadHistory);
                
                // 點擊拖放區域選擇檔案
                UI.dropZone.addEventListener('click', function() {
                    UI.fileInput.click();
                });
            }
            
            /**
             * 設定拖放區域的事件處理
             */
            function setupDragAndDropEvents() {
                // 防止預設行為
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    UI.dropZone.addEventListener(eventName, preventDefaults, false);
                });
                
                // 高亮效果
                ['dragenter', 'dragover'].forEach(eventName => {
                    UI.dropZone.addEventListener(eventName, highlight, false);
                });
                
                // 移除高亮效果
                ['dragleave', 'drop'].forEach(eventName => {
                    UI.dropZone.addEventListener(eventName, unhighlight, false);
                });
                
                // 處理檔案拖放
                UI.dropZone.addEventListener('drop', handleDrop, false);
            }
            
            /**
             * 處理編輯 API URL 按鈕點擊
             */
            function handleEditApiUrl() {
                UI.apiUrlInput.readOnly = false;
                UI.apiUrlInput.focus();
                UI.editApiUrlBtn.style.display = 'none';
                UI.saveApiUrlBtn.style.display = 'block';
            }
            
            /**
             * 處理儲存 API URL 按鈕點擊
             */
            function handleSaveApiUrl() {
                const newUrl = UI.apiUrlInput.value.trim();
                
                if (validateApiUrl(newUrl)) {
                    AppConfig.apiUrl = newUrl;
                    localStorage.setItem(AppConfig.storageKeys.apiUrl, newUrl);
                    UI.apiUrlInput.readOnly = true;
                    UI.editApiUrlBtn.style.display = 'block';
                    UI.saveApiUrlBtn.style.display = 'none';
                    
                    // 檢查新 API 的連接狀態
                    checkApiConnection();
                    
                    showAlert('API 網址已成功儲存', 'success');
                } else {
                    showAlert('請輸入有效的 Google Apps Script 網址', 'error');
                }
            }
            
            /**
             * 驗證 API URL 格式
             * @param {string} url - 要驗證的 URL
             * @returns {boolean} - URL 是否有效
             */
            function validateApiUrl(url) {
                if (!url) return false;
                
                try {
                    new URL(url);
                } catch (e) {
                    return false;
                }
                
                // 基本檢查 Google Apps Script URL 格式
                return url.startsWith('https://script.google.com/macros/s/') && 
                       url.includes('/exec');
            }
            
            /**
             * 使用JSONP檢查 API 連接狀態 (避免CORS問題)
             */
            function checkApiConnection() {
                updateApiStatus('checking');
                
                // 創建唯一的回調函數名稱
                const callbackName = 'apiCallback_' + Math.random().toString(36).substring(2, 15);
                
                // 設置全局回調函數
                window[callbackName] = function(response) {
                    console.log('API 連接成功:', response);
                    AppState.apiConnected = true;
                    updateApiStatus('connected');
                    
                    // 清理回調函數
                    delete window[callbackName];
                };
                
                // 創建script標籤來執行JSONP請求
                const script = document.createElement('script');
                script.src = `${AppConfig.apiUrl}?callback=${callbackName}&action=ping`;
                
                // 設置超時處理
                const timeoutId = setTimeout(function() {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    console.error('API 連接超時');
                    AppState.apiConnected = false;
                    updateApiStatus('error');
                    delete window[callbackName];
                }, 10000); // 10秒超時
                
                // 處理加載錯誤
                script.onerror = function() {
                    clearTimeout(timeoutId);
                    console.error('API 連接失敗');
                    AppState.apiConnected = false;
                    updateApiStatus('error');
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                // 處理加載完成
                script.onload = function() {
                    clearTimeout(timeoutId);
                };
                
                // 添加到DOM以執行請求
                document.body.appendChild(script);
            }
            
            /**
             * 更新 API 狀態指示器
             * @param {string} status - 連接狀態 ('checking', 'connected', 'error')
             */
            function updateApiStatus(status) {
                let badgeHTML = '';
                
                switch (status) {
                    case 'checking':
                        badgeHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-sync-alt fa-spin"></i> 檢查連接中...</span>';
                        break;
                    case 'connected':
                        badgeHTML = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> 已連接</span>';
                        break;
                    case 'error':
                        badgeHTML = '<span class="badge bg-danger"><i class="fas fa-exclamation-circle"></i> 連接失敗</span>';
                        break;
                    default:
                        badgeHTML = '<span class="badge bg-secondary">未知狀態</span>';
                }
                
                UI.apiStatus.innerHTML = badgeHTML;
            }
            
            /**
             * 防止拖放預設行為
             * @param {Event} e - 事件物件
             */
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            /**
             * 添加拖放區域高亮效果
             */
            function highlight() {
                UI.dropZone.classList.add('highlight');
            }
            
            /**
             * 移除拖放區域高亮效果
             */
            function unhighlight() {
                UI.dropZone.classList.remove('highlight');
            }
            
            /**
             * 處理檔案拖放事件
             * @param {DragEvent} e - 拖放事件物件
             */
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleFiles(files[0]);
                }
            }
            
            /**
             * 處理檔案選擇事件
             * @param {Event} e - 檔案選擇事件物件
             */
            function handleFileSelect(e) {
                const files = e.target.files;
                
                if (files.length > 0) {
                    handleFiles(files[0]);
                }
            }
            
            /**
             * 處理選擇的檔案
             * @param {File} file - 選擇的檔案
             */
            function handleFiles(file) {
                // 儲存選擇的檔案
                AppState.selectedFile = file;
                
                // 顯示檔案資訊
                displayFileInfo(file);
                
                // 啟用上傳按鈕
                UI.uploadBtn.disabled = false;
                
                console.log('已選擇檔案:', file.name);
            }
            
            /**
             * 顯示檔案資訊
             * @param {File} file - 要顯示資訊的檔案
             */
            function displayFileInfo(file) {
                UI.fileName.textContent = file.name;
                UI.fileType.textContent = file.type || '未知';
                UI.fileSize.textContent = formatFileSize(file.size);
                UI.fileModified.textContent = new Date(file.lastModified).toLocaleString();
                UI.fileInfoContainer.style.display = 'block';
            }
            
            /**
             * 格式化檔案大小為易讀格式
             * @param {number} bytes - 檔案大小 (位元組)
             * @returns {string} - 格式化後的檔案大小
             */
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            /**
             * 處理檔案上傳按鈕點擊
             */
            function handleUpload() {
                // 檢查是否有選擇檔案
                if (!AppState.selectedFile) {
                    showAlert('請先選擇檔案', 'error');
                    return;
                }
                
                // 檢查 API 連接狀態
                if (!AppState.apiConnected) {
                    showAlert('無法連接至 API，請檢查設定', 'error');
                    return;
                }
                
                // 檢查檔案大小
                if (AppState.selectedFile.size > AppConfig.maxFileSize) {
                    showAlert(`檔案大小超過限制 (最大 ${formatFileSize(AppConfig.maxFileSize)})`, 'error');
                    return;
                }
                
                // 開始上傳流程
                startUpload();
            }
            
            /**
             * 開始上傳流程
             */
            function startUpload() {
                // 設定上傳狀態
                AppState.isUploading = true;
                
                // 重置介面
                resetAlerts();
                UI.uploadBtn.disabled = true;
                UI.resultSection.style.display = 'none';
                
                // 顯示進度
                UI.progressContainer.style.display = 'block';
                updateProgress(0, '正在準備上傳...');
                
                // 讀取檔案
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    uploadFileViaForm(AppState.selectedFile, e.target.result);
                };
                
                reader.onerror = function() {
                    handleUploadError('讀取檔案時發生錯誤');
                };
                
                reader.readAsDataURL(AppState.selectedFile);
            }
            
            /**
             * 使用表單重定向上傳檔案至GAS (繞過CORS限制)
             * @param {File} file - 要上傳的檔案
             * @param {string} fileData - 檔案的Base64編碼資料
             */
            function uploadFileViaForm(file, fileData) {
                // 顯示上傳進度
                startProgressSimulation();
                
                // 顯示載入指示器
                UI.loaderContainer.style.display = 'block';
                
                console.log('開始檔案上傳:', file.name);
                
                // 創建上傳ID
                const uploadId = 'upload_' + new Date().getTime();
                
                // 存儲上傳信息到本地存儲
                localStorage.setItem(AppConfig.storageKeys.currentUpload, JSON.stringify({
                    id: uploadId,
                    fileName: file.name,
                    fileType: file.type || 'application/octet-stream',
                    fileSize: file.size,
                    timestamp: new Date().toISOString()
                }));
                
                // 準備上傳數據
                const uploadData = {
                    fileName: file.name,
                    fileType: file.type || 'application/octet-stream',
                    fileData: fileData,
                    timestamp: new Date().toISOString()
                };
                
                // 創建表單
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = AppConfig.apiUrl;
                
                // 添加JSON數據作為隱藏輸入
                const dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.name = 'data';
                dataInput.value = JSON.stringify(uploadData);
                form.appendChild(dataInput);
                
                // 添加返回URL參數
                const returnInput = document.createElement('input');
                returnInput.type = 'hidden';
                returnInput.name = 'return_url';
                returnInput.value = window.location.href + '?upload_success=true&id=' + uploadId;
                form.appendChild(returnInput);
                
                // 設置提交目標為新窗口
                const windowName = 'upload_window_' + Math.random().toString(36).substring(2, 15);
                form.target = windowName;
                
                // 添加表單到DOM並提交
                document.body.appendChild(form);
                
                // 打開一個小窗口來接收表單提交
                const uploadWindow = window.open('about:blank', windowName, 'width=200,height=100');
                
                // 提交表單
                form.submit();
                
                // 提交後移除表單
                setTimeout(() => {
                    document.body.removeChild(form);
                }, 100);
                
                // 設置上傳檢查計時器
                if (AppState.uploadCheckTimer) {
                    clearInterval(AppState.uploadCheckTimer);
                }
                
                // 每秒檢查一次URL參數變化
                AppState.uploadCheckTimer = setInterval(() => {
                    // 檢查窗口是否已關閉
                    if (uploadWindow && uploadWindow.closed) {
                        clearInterval(AppState.uploadCheckTimer);
                        
                        // 檢查URL參數是否已更新
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('upload_success') === 'true' && urlParams.get('id') === uploadId) {
                            // 參數已更新，處理已在handleRedirectParams中
                        } else {
                            // 窗口關閉但無重定向，可能是用戶取消
                            handleUploadError('上傳已取消或發生錯誤');
                            
                            // 清除本地存儲
                            localStorage.removeItem(AppConfig.storageKeys.currentUpload);
                        }
                    }
                }, 1000);
                
                // 90秒後自動取消檢查
                setTimeout(() => {
                    if (AppState.uploadCheckTimer) {
                        clearInterval(AppState.uploadCheckTimer);
                        
                        // 檢查是否已成功
                        const urlParams = new URLSearchParams(window.location.search);
                        if (!(urlParams.get('upload_success') === 'true' && urlParams.get('id') === uploadId)) {
                            // 未成功且超時
                            handleUploadError('上傳逾時，請稍後再試');
                            
                            // 清除本地存儲
                            localStorage.removeItem(AppConfig.storageKeys.currentUpload);
                        }
                    }
                }, 90000);
            }
            
            /**
             * 開始上傳進度模擬
             */
            function startProgressSimulation() {
                // 清除已有計時器
                if (AppState.progressInterval) {
                    clearInterval(AppState.progressInterval);
                }
                
                let width = AppConfig.progressSimulation.initialValue;
                
                // 設定進度更新間隔
                AppState.progressInterval = setInterval(function() {
                    if (width >= AppConfig.progressSimulation.maxSimulatedValue) {
                        clearInterval(AppState.progressInterval);
                    } else {
                        width += AppConfig.progressSimulation.incrementStep;
                        updateProgress(width, '上傳中...');
                    }
                }, AppConfig.progressSimulation.intervalTime);
            }
            
            /**
             * 更新進度條
             * @param {number} percent - 進度百分比
             * @param {string} statusText - 狀態文字
             */
            function updateProgress(percent, statusText) {
                UI.progressBar.style.width = percent + '%';
                UI.progressBar.setAttribute('aria-valuenow', percent);
                UI.progressPercentage.textContent = percent + '%';
                
                if (statusText) {
                    UI.uploadStatusText.textContent = statusText;
                }
            }
            
            /**
             * 處理上傳成功
             * @param {Object} data - 成功回應資料
             */
            function handleUploadSuccess(data) {
                // 清除進度模擬
                if (AppState.progressInterval) {
                    clearInterval(AppState.progressInterval);
                }
                
                // 清除上傳檢查計時器
                if (AppState.uploadCheckTimer) {
                    clearInterval(AppState.uploadCheckTimer);
                }
                
                // 完成進度條
                updateProgress(100, '上傳完成！');
                
                // 隱藏載入指示器
                UI.loaderContainer.style.display = 'none';
                
                // 顯示成功訊息
                showAlert('檔案已成功上傳！', 'success');
                
                // 顯示結果區域
                if (data.fileUrl) {
                    UI.resultLink.href = data.fileUrl;
                    UI.resultText.textContent = `您的檔案「${data.fileName || AppState.selectedFile.name}」已成功上傳至 Google Drive。`;
                    UI.resultSection.style.display = 'block';
                }
                
                // 重新載入上傳歷史
                setTimeout(loadUploadHistory, 1000);
                
                // 延遲重置 UI
                setTimeout(resetUploadUI, 2000);
                
                // 重設上傳狀態
                AppState.isUploading = false;
            }
            
            /**
             * 處理上傳錯誤
             * @param {string} errorMsg - 錯誤訊息
             */
            function handleUploadError(errorMsg) {
                // 清除進度模擬
                if (AppState.progressInterval) {
                    clearInterval(AppState.progressInterval);
                }
                
                // 清除上傳檢查計時器
                if (AppState.uploadCheckTimer) {
                    clearInterval(AppState.uploadCheckTimer);
                }
                
                // 重置進度條
                updateProgress(0, '上傳失敗');
                
                // 隱藏載入指示器
                UI.loaderContainer.style.display = 'none';
                
                // 顯示錯誤訊息
                showAlert('上傳失敗: ' + errorMsg, 'error');
                
                // 重置 UI
                resetUploadUI();
                
                // 重設上傳狀態
                AppState.isUploading = false;
            }
            
            /**
             * 重置上傳 UI
             */
            function resetUploadUI() {
                UI.uploadBtn.disabled = false;
                UI.progressContainer.style.display = 'none';
                UI.fileInput.value = '';
            }
            
            /**
             * 顯示提示訊息
             * @param {string} message - 提示訊息內容
             * @param {string} type - 提示類型 ('success' 或 'error')
             */
            function showAlert(message, type) {
                resetAlerts();
                
                if (type === 'success') {
                    UI.successMessage.textContent = message;
                    UI.successAlert.style.display = 'block';
                    
                    // 自動隱藏成功訊息
                    setTimeout(() => {
                        UI.successAlert.style.display = 'none';
                    }, AppConfig.alertDisplayTime);
                } else {
                    UI.errorMessage.textContent = message;
                    UI.errorAlert.style.display = 'block';
                }
            }
            
            /**
             * 重置所有提示訊息
             */
            function resetAlerts() {
                UI.successAlert.style.display = 'none';
                UI.errorAlert.style.display = 'none';
            }
            
            /**
             * 使用JSONP加載上傳歷史記錄 (繞過CORS限制)
             */
            function loadUploadHistory() {
                // 顯示載入指示器
                UI.loaderContainer.style.display = 'block';
                
                // 創建唯一的回調函數名稱
                const callbackName = 'historyCallback_' + Math.random().toString(36).substring(2, 15);
                
                // 設置全局回調函數
                window[callbackName] = function(response) {
                    console.log('歷史記錄載入成功:', response);
                    displayUploadHistory(response);
                    
                    // 隱藏載入指示器
                    UI.loaderContainer.style.display = 'none';
                    
                    // 清理回調函數
                    delete window[callbackName];
                };
                
                // 創建script標籤來執行JSONP請求
                const script = document.createElement('script');
                script.src = `${AppConfig.apiUrl}?callback=${callbackName}&action=getHistory`;
                
                // 設置超時處理
                const timeoutId = setTimeout(function() {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    console.error('載入歷史記錄超時');
                    UI.loaderContainer.style.display = 'none';
                    
                    // 顯示空歷史視圖
                    UI.historyEmpty.style.display = 'block';
                    UI.historyTableContainer.style.display = 'none';
                    
                    delete window[callbackName];
                }, 10000); // 10秒超時
                
                // 處理加載錯誤
                script.onerror = function() {
                    clearTimeout(timeoutId);
                    console.error('載入歷史記錄失敗');
                    UI.loaderContainer.style.display = 'none';
                    
                    // 顯示空歷史視圖
                    UI.historyEmpty.style.display = 'block';
                    UI.historyTableContainer.style.display = 'none';
                    
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                // 處理加載完成
                script.onload = function() {
                    clearTimeout(timeoutId);
                };
                
                // 添加到DOM以執行請求
                document.body.appendChild(script);
            }
            
            /**
             * 顯示上傳歷史記錄
             * @param {Object} data - 歷史記錄資料
             */
            function displayUploadHistory(data) {
                // 清空表格內容
                UI.historyTableBody.innerHTML = '';
                
                if (data.success && data.records && data.records.length > 0) {
                    // 有歷史記錄，顯示表格
                    UI.historyEmpty.style.display = 'none';
                    UI.historyTableContainer.style.display = 'block';
                    
                    // 按時間降序排列
                    const sortedRecords = data.records.sort((a, b) => {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
                    
                    // 添加記錄到表格
                    sortedRecords.forEach(record => {
                        const row = document.createElement('tr');
                        
                        // 格式化時間
                        const date = new Date(record.timestamp);
                        const formattedDate = date.toLocaleString();
                        
                        // 構建表格行
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${record.fileName}</td>
                            <td>${record.fileType || '未知'}</td>
                            <td>${typeof record.fileSize === 'number' ? formatFileSize(record.fileSize) : record.fileSize}</td>
                            <td>
                                <a href="${record.fileUrl}" target="_blank" class="file-link">
                                    <i class="fas fa-external-link-alt"></i> 查看
                                </a>
                            </td>
                        `;
                        
                        UI.historyTableBody.appendChild(row);
                    });
                } else {
                    // 無歷史記錄，顯示空狀態
                    UI.historyEmpty.style.display = 'block';
                    UI.historyTableContainer.style.display = 'none';
                }
            }
            
            // 初始化應用程式
            document.addEventListener('DOMContentLoaded', initializeApp);
        })();
    </script>
</body>
</html>
