<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>檔案上傳系統 - 連接 Google Drive</title>
    
    <!-- 載入 Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    
    <!-- 載入 Font Awesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /**
         * 主要樣式定義 - 暗色主題
         * 針對檔案上傳系統的所有UI元素提供專用樣式
         */
        :root {
            --primary-color: #3d7fff;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --dark-bg: #121212;
            --dark-surface: #1e1e1e;
            --dark-card: #252525;
            --dark-input: #333333;
            --dark-border: #444444;
            --dark-text: #e0e0e0;
            --dark-text-secondary: #aaaaaa;
            --dark-hover: #2c2c2c;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            --transition-speed: 0.3s;
        }
        
        body {
            background-color: var(--dark-bg);
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            padding-bottom: 50px;
        }
        
        .page-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--dark-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .header-section h1 {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header-section p {
            color: var(--dark-text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .main-card {
            background-color: var(--dark-card);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .api-config-section {
            padding: 15px;
            background-color: rgba(61, 127, 255, 0.1);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid rgba(61, 127, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        .api-status {
            display: inline-block;
        }
        
        /* 拖放區域樣式 */
        .drop-zone {
            border: 3px dashed var(--dark-border);
            border-radius: var(--border-radius);
            padding: 50px 20px;
            text-align: center;
            transition: all var(--transition-speed) ease;
            background-color: var(--dark-surface);
            position: relative;
            cursor: pointer;
        }
        
        .drop-zone.highlight {
            border-color: var(--primary-color);
            background-color: rgba(61, 127, 255, 0.1);
        }
        
        .drop-zone i.main-icon {
            font-size: 60px;
            color: var(--dark-text-secondary);
            margin-bottom: 15px;
            transition: all var(--transition-speed) ease;
        }
        
        .drop-zone:hover i.main-icon {
            color: var(--primary-color);
        }
        
        .drop-zone h3 {
            font-size: 22px;
            color: var(--dark-text);
            margin-bottom: 10px;
        }
        
        .drop-zone p {
            color: var(--dark-text-secondary);
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .select-file-btn {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transition: all var(--transition-speed) ease;
        }
        
        .select-file-btn:hover {
            background-color: #2d5cb3;
            border-color: #2d5cb3;
        }
        
        /* 檔案資訊顯示區域 */
        .file-info-container {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--dark-surface);
            border-radius: var(--border-radius);
            border: 1px solid var(--dark-border);
            display: none;
        }
        
        .file-info-container h4 {
            margin-bottom: 15px;
            color: var(--dark-text);
            display: flex;
            align-items: center;
        }
        
        .file-info-container h4 i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .file-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .file-info-item {
            padding: 10px;
            background-color: var(--dark-input);
            border-radius: 8px;
            border: 1px solid var(--dark-border);
        }
        
        .file-info-item .info-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-text-secondary);
        }
        
        .file-info-item .info-value {
            word-break: break-all;
            color: var(--dark-text);
        }
        
        /* 進度顯示區域 */
        .progress-container {
            margin-top: 30px;
            display: none;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--dark-text);
        }
        
        .progress {
            height: 25px;
            margin-bottom: 10px;
            border-radius: 50px;
            background-color: var(--dark-input);
        }
        
        .progress-bar {
            border-radius: 50px;
            transition: width 0.3s ease;
        }
        
        /* 上傳按鈕 */
        .upload-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color var(--transition-speed);
            position: relative;
        }
        
        .upload-btn:hover {
            background-color: #157347;
        }
        
        .upload-btn:disabled {
            background-color: #555555;
            cursor: not-allowed;
        }
        
        .upload-btn i {
            margin-right: 10px;
        }
        
        /* 狀態提示訊息 */
        .status-alert {
            margin-top: 20px;
            display: none;
            border-radius: 8px;
        }
        
        /* 結果顯示區域 */
        .result-section {
            margin-top: 30px;
            display: none;
        }
        
        .result-section .card {
            background-color: var(--dark-surface);
            border: none;
            border-left: 5px solid var(--success-color);
        }
        
        .result-section .card-body {
            padding: 20px;
            color: var(--dark-text);
        }
        
        .result-section .card-title {
            color: var(--dark-text);
            margin-bottom: 15px;
        }
        
        .result-link {
            display: inline-flex;
            align-items: center;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .result-link:hover {
            text-decoration: underline;
        }
        
        .result-link i {
            margin-right: 5px;
        }
        
        /* 載入指示器 */
        .loader-container {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loader {
            border: 5px solid var(--dark-surface);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 頁尾版權資訊 */
        .footer {
            text-align: center;
            margin-top: 40px;
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
        }
        
        /* Custom Alert Styling */
        .custom-alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            position: relative;
            display: none;
        }
        
        .custom-alert.success {
            background-color: rgba(25, 135, 84, 0.2);
            border: 1px solid rgba(25, 135, 84, 0.3);
            color: #4ad0a4;
        }
        
        .custom-alert.error {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #ff7a85;
        }
        
        .custom-alert i {
            margin-right: 10px;
        }
        
        .custom-alert .close-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            cursor: pointer;
            color: var(--dark-text-secondary);
        }
        
        /* 響應式設計調整 */
        @media (max-width: 768px) {
            .file-info-grid {
                grid-template-columns: 1fr;
            }
            
            .main-card {
                padding: 20px;
            }
            
            .drop-zone {
                padding: 30px 15px;
            }
            
            .drop-zone i.main-icon {
                font-size: 50px;
            }
            
            .drop-zone h3 {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="page-container">
        <!-- 頁頭區塊 -->
        <div class="header-section">
            <h1><i class="fas fa-cloud-upload-alt"></i> 檔案上傳系統</h1>
            <p>安全地將檔案上傳至 Google Drive 指定資料夾</p>
        </div>
        
        <!-- 主要操作區塊 -->
        <div class="main-card">
            <!-- API 狀態區塊 (簡化版) -->
            <div class="api-config-section">
                <div class="api-status" id="api-status">
                    <span class="badge bg-secondary">檢查連接中...</span>
                </div>
            </div>
            
            <!-- 檔案上傳區塊 -->
            <div id="drop-zone" class="drop-zone">
                <i class="fas fa-file-upload main-icon"></i>
                <h3>拖放檔案至此區域</h3>
                <p>或者點擊此處選擇檔案</p>
                <span class="btn btn-primary select-file-btn">選擇檔案</span>
                <input type="file" id="file-input" class="file-input">
            </div>
            
            <!-- 檔案資訊顯示區塊 -->
            <div id="file-info-container" class="file-info-container">
                <h4><i class="fas fa-file-alt"></i> 檔案資訊</h4>
                <div class="file-info-grid">
                    <div class="file-info-item">
                        <div class="info-label">檔案名稱</div>
                        <div class="info-value" id="file-name">-</div>
                    </div>
                    <div class="file-info-item">
                        <div class="info-label">檔案類型</div>
                        <div class="info-value" id="file-type">-</div>
                    </div>
                    <div class="file-info-item">
                        <div class="info-label">檔案大小</div>
                        <div class="info-value" id="file-size">-</div>
                    </div>
                    <div class="file-info-item">
                        <div class="info-label">最後修改</div>
                        <div class="info-value" id="file-modified">-</div>
                    </div>
                </div>
            </div>
            
            <!-- 上傳進度顯示區塊 -->
            <div id="progress-container" class="progress-container">
                <div class="progress-label">
                    <span>上傳進度</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="progress">
                    <div 
                        id="progress-bar" 
                        class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                        role="progressbar" 
                        aria-valuenow="0" 
                        aria-valuemin="0" 
                        aria-valuemax="100" 
                        style="width: 0%">
                    </div>
                </div>
                <div class="text-center text-muted" id="upload-status-text">準備上傳中...</div>
            </div>
            
            <!-- 載入指示器 -->
            <div id="loader-container" class="loader-container">
                <div class="loader"></div>
                <p class="mt-2 text-muted">處理中，請稍候...</p>
            </div>
            
            <!-- 自定義警告 -->
            <div id="success-alert" class="custom-alert success">
                <i class="fas fa-check-circle"></i>
                <span id="success-message"></span>
                <span class="close-btn"><i class="fas fa-times"></i></span>
            </div>
            
            <div id="error-alert" class="custom-alert error">
                <i class="fas fa-exclamation-circle"></i>
                <span id="error-message"></span>
                <span class="close-btn"><i class="fas fa-times"></i></span>
            </div>
            
            <!-- 上傳按鈕 -->
            <button id="upload-btn" class="upload-btn" disabled>
                <i class="fas fa-cloud-upload-alt"></i> 上傳檔案
            </button>
            
            <!-- 上傳結果顯示區域 -->
            <div id="result-section" class="result-section">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-check-circle text-success"></i> 檔案上傳成功</h5>
                        <p class="card-text" id="result-text">您的檔案已成功上傳至 Google Drive。</p>
                        <a id="result-link" href="#" target="_blank" class="result-link">
                            <i class="fas fa-external-link-alt"></i> 在 Google Drive 中查看
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 頁尾版權資訊 -->
        <div class="footer">
            <p>&copy; 2025 檔案上傳系統 | 使用 GitHub Pages 與 Google Apps Script</p>
        </div>
    </div>
    
    <!-- 載入 Bootstrap 5 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<!-- 主要應用程式邏輯 -->
    <script>
        /**
         * 檔案上傳系統 - 前端應用程式 (多通道通信版本)
         * 
         * 此腳本實現與 Google Apps Script 通訊的檔案上傳功能
         * 使用多通道通信機制確保上傳狀態可靠同步
         * 
         * @version 4.0.0
         * @date 2025-04-12
         */
        
        // 使用立即執行函數表達式 (IIFE) 建立模組化程式
        (function() {
            'use strict';
            
            /**
             * 應用程式配置
             * @type {Object}
             */
            const AppConfig = {
                // API 相關設定
                apiUrl: 'https://script.google.com/macros/s/AKfycbyXPv6OTGrPggsk4wg9Ow1uxXSf_Df-GWqYCBIps1ZTSMLCHc0bsfIHq3ab6S1fGSJ8ng/exec',
                
                // 檔案上傳限制
                maxFileSize: 50 * 1024 * 1024, // 50MB (Google Apps Script 限制)
                
                // 進度模擬設定
                progressSimulation: {
                    initialValue: 0,
                    maxSimulatedValue: 90,
                    incrementStep: 5,
                    intervalTime: 300 // 毫秒
                },
                
                // 提示訊息顯示持續時間
                alertDisplayTime: 5000, // 5秒
                
                // 超時設定
                pollingInterval: 3000, // 每3秒輪詢一次
                maxPollDuration: 300000, // 最長輪詢5分鐘
                
                // 本地儲存鍵名
                storageKeys: {
                    apiUrl: 'gas_api_url',
                    currentUpload: 'currentUpload'
                }
            };
            
            /**
             * 使用者介面元素參照
             * @type {Object}
             */
            const UI = {
                // API 相關元素
                apiStatus: document.getElementById('api-status'),
                
                // 檔案選擇和顯示元素
                dropZone: document.getElementById('drop-zone'),
                fileInput: document.getElementById('file-input'),
                fileInfoContainer: document.getElementById('file-info-container'),
                fileName: document.getElementById('file-name'),
                fileType: document.getElementById('file-type'),
                fileSize: document.getElementById('file-size'),
                fileModified: document.getElementById('file-modified'),
                
                // 上傳相關元素
                uploadBtn: document.getElementById('upload-btn'),
                progressContainer: document.getElementById('progress-container'),
                progressBar: document.getElementById('progress-bar'),
                progressPercentage: document.getElementById('progress-percentage'),
                uploadStatusText: document.getElementById('upload-status-text'),
                loaderContainer: document.getElementById('loader-container'),
                
                // 狀態和結果顯示元素
                successAlert: document.getElementById('success-alert'),
                errorAlert: document.getElementById('error-alert'),
                successMessage: document.getElementById('success-message'),
                errorMessage: document.getElementById('error-message'),
                resultSection: document.getElementById('result-section'),
                resultText: document.getElementById('result-text'),
                resultLink: document.getElementById('result-link'),
            };
            
            /**
             * 應用程式狀態
             * @type {Object}
             */
            const AppState = {
                // 目前選擇的檔案
                selectedFile: null,
                
                // 上傳進度模擬計時器
                progressInterval: null,
                
                // API 連接狀態
                apiConnected: false,
                
                // 上傳狀態
                isUploading: false,
                
                // 上傳檢查計時器
                uploadCheckTimer: null,
                
                // 當前上傳ID
                currentUploadId: null,
            };
            
            /**
             * 初始化應用程式
             */
            function initializeApp() {
                console.log('初始化檔案上傳應用程式...');
                
                // 檢查URL參數，處理潛在的上傳重定向
                handleRedirectParams();
                
                // 設定事件監聽
                setupEventListeners();
                
                // 驗證 API 連接
                checkApiConnection();
                
                console.log('應用程式初始化完成');
            }
            
            /**
             * 處理URL重定向參數
             */
            function handleRedirectParams() {
                const urlParams = new URLSearchParams(window.location.search);
                
                // 檢查上傳成功參數
                if (urlParams.get('upload_success') === 'true') {
                    // 獲取上傳ID
                    const uploadId = urlParams.get('id');
                    if (uploadId) {
                        // 從localStorage獲取上傳信息
                        const uploadInfo = JSON.parse(localStorage.getItem(AppConfig.storageKeys.currentUpload)) || {};
                        
                        if (uploadInfo.id === uploadId) {
                            // 清除URL參數
                            if (window.history && window.history.replaceState) {
                                window.history.replaceState({}, document.title, window.location.pathname);
                            }
                            
                            // 獲取檔案URL
                            const fileUrl = urlParams.get('fileUrl') || '#';
                            
                            // 模擬上傳成功
                            setTimeout(() => {
                                handleUploadSuccess({
                                    success: true,
                                    fileName: uploadInfo.fileName,
                                    fileUrl: fileUrl,
                                    message: '檔案上傳成功',
                                    timestamp: new Date().toISOString()
                                });
                                
                                // 清除本地存儲
                                localStorage.removeItem(AppConfig.storageKeys.currentUpload);
                            }, 500);
                        }
                    }
                }
                
                // 檢查錯誤參數
                if (urlParams.get('error')) {
                    const errorMsg = urlParams.get('error');
                    
                    // 清除URL參數
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                    
                    // 顯示錯誤信息
                    setTimeout(() => {
                        handleUploadError(decodeURIComponent(errorMsg));
                        
                        // 清除本地存儲
                        localStorage.removeItem(AppConfig.storageKeys.currentUpload);
                    }, 500);
                }
            }

/**
             * 設定所有事件監聽器
             */
            function setupEventListeners() {
                // 拖放區域事件
                setupDragAndDropEvents();
                
                // 檔案選擇事件
                UI.fileInput.addEventListener('change', handleFileSelect);
                
                // 上傳按鈕事件
                UI.uploadBtn.addEventListener('click', handleUpload);
                
                // 點擊拖放區域選擇檔案
                UI.dropZone.addEventListener('click', function() {
                    UI.fileInput.click();
                });
                
                // 關閉警告按鈕
                document.querySelectorAll('.custom-alert .close-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        this.parentElement.style.display = 'none';
                    });
                });
                
                // 設置窗口消息監聽器
                setupGlobalMessageListener();
            }
            
            /**
             * 設定全局消息監聽器
             */
            function setupGlobalMessageListener() {
                // 如果已有監聽器，先移除
                if (window.messageHandler) {
                    window.removeEventListener('message', window.messageHandler);
                }
                
                // 創建並保存引用以便後續可以移除
                window.messageHandler = function(event) {
                    // 處理來自上傳窗口的消息
                    try {
                        console.log("收到窗口消息:", event.data);
                        
                        const data = event.data;
                        // 簡單驗證消息格式
                        if (data && data.status && data.uploadId) {
                            // 檢查是否是當前上傳的ID
                            if (data.uploadId === AppState.currentUploadId) {
                                if (data.status === 'success' && data.fileUrl) {
                                    clearPollingAndProcessSuccess(data.uploadId, data.fileUrl);
                                } else if (data.status === 'error') {
                                    clearPollingAndProcessError(data.uploadId, data.message || '上傳過程中發生錯誤');
                                }
                            }
                        }
                    } catch (e) {
                        console.error("處理窗口消息時發生錯誤:", e);
                    }
                };
                
                // 添加監聽器
                window.addEventListener('message', window.messageHandler);
            }
            
            /**
             * 設定拖放區域的事件處理
             */
            function setupDragAndDropEvents() {
                // 防止預設行為
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    UI.dropZone.addEventListener(eventName, preventDefaults, false);
                });
                
                // 高亮效果
                ['dragenter', 'dragover'].forEach(eventName => {
                    UI.dropZone.addEventListener(eventName, highlight, false);
                });
                
                // 移除高亮效果
                ['dragleave', 'drop'].forEach(eventName => {
                    UI.dropZone.addEventListener(eventName, unhighlight, false);
                });
                
                // 處理檔案拖放
                UI.dropZone.addEventListener('drop', handleDrop, false);
            }
            
            /**
             * 防止拖放預設行為
             * @param {Event} e - 事件物件
             */
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            /**
             * 添加拖放區域高亮效果
             */
            function highlight() {
                UI.dropZone.classList.add('highlight');
            }
            
            /**
             * 移除拖放區域高亮效果
             */
            function unhighlight() {
                UI.dropZone.classList.remove('highlight');
            }
            
            /**
             * 處理檔案拖放事件
             * @param {DragEvent} e - 拖放事件物件
             */
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleFiles(files[0]);
                }
            }
            
            /**
             * 處理檔案選擇事件
             * @param {Event} e - 檔案選擇事件物件
             */
            function handleFileSelect(e) {
                const files = e.target.files;
                
                if (files.length > 0) {
                    handleFiles(files[0]);
                }
            }
            
            /**
             * 處理選擇的檔案
             * @param {File} file - 選擇的檔案
             */
            function handleFiles(file) {
                // 儲存選擇的檔案
                AppState.selectedFile = file;
                
                // 顯示檔案資訊
                displayFileInfo(file);
                
                // 啟用上傳按鈕
                UI.uploadBtn.disabled = false;
                
                console.log('已選擇檔案:', file.name);
            }
            
            /**
             * 顯示檔案資訊
             * @param {File} file - 要顯示資訊的檔案
             */
            function displayFileInfo(file) {
                UI.fileName.textContent = file.name;
                UI.fileType.textContent = file.type || '未知';
                UI.fileSize.textContent = formatFileSize(file.size);
                UI.fileModified.textContent = new Date(file.lastModified).toLocaleString();
                UI.fileInfoContainer.style.display = 'block';
            }
            
            /**
             * 格式化檔案大小為易讀格式
             * @param {number} bytes - 檔案大小 (位元組)
             * @returns {string} - 格式化後的檔案大小
             */
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

/**
             * 使用JSONP檢查 API 連接狀態 (避免CORS問題)
             */
            function checkApiConnection() {
                updateApiStatus('checking');
                
                // 創建唯一的回調函數名稱
                const callbackName = 'apiCallback_' + Math.random().toString(36).substring(2, 15);
                
                // 設置全局回調函數
                window[callbackName] = function(response) {
                    console.log('API 連接成功:', response);
                    AppState.apiConnected = true;
                    updateApiStatus('connected');
                    
                    // 清理回調函數
                    delete window[callbackName];
                };
                
                // 創建script標籤來執行JSONP請求
                const script = document.createElement('script');
                script.src = `${AppConfig.apiUrl}?callback=${callbackName}&action=ping&nocache=${new Date().getTime()}`;
                
                // 設置超時處理
                const timeoutId = setTimeout(function() {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    console.error('API 連接超時');
                    AppState.apiConnected = false;
                    updateApiStatus('error');
                    delete window[callbackName];
                }, 10000); // 10秒超時
                
                // 處理加載錯誤
                script.onerror = function() {
                    clearTimeout(timeoutId);
                    console.error('API 連接失敗');
                    AppState.apiConnected = false;
                    updateApiStatus('error');
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                // 處理加載完成
                script.onload = function() {
                    clearTimeout(timeoutId);
                };
                
                // 添加到DOM以執行請求
                document.body.appendChild(script);
            }
            
            /**
             * 更新 API 狀態指示器
             * @param {string} status - 連接狀態 ('checking', 'connected', 'error')
             */
            function updateApiStatus(status) {
                let badgeHTML = '';
                
                switch (status) {
                    case 'checking':
                        badgeHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-sync-alt fa-spin"></i> 檢查連接中...</span>';
                        break;
                    case 'connected':
                        badgeHTML = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> 已連接</span>';
                        break;
                    case 'error':
                        badgeHTML = '<span class="badge bg-danger"><i class="fas fa-exclamation-circle"></i> 連接失敗</span>';
                        break;
                    default:
                        badgeHTML = '<span class="badge bg-secondary">未知狀態</span>';
                }
                
                UI.apiStatus.innerHTML = badgeHTML;
            }
            
            /**
             * 處理檔案上傳按鈕點擊
             */
            function handleUpload() {
                // 檢查是否有選擇檔案
                if (!AppState.selectedFile) {
                    showAlert('請先選擇檔案', 'error');
                    return;
                }
                
                // 檢查 API 連接狀態
                if (!AppState.apiConnected) {
                    showAlert('無法連接至 API，請檢查設定', 'error');
                    return;
                }
                
                // 檢查檔案大小
                if (AppState.selectedFile.size > AppConfig.maxFileSize) {
                    showAlert(`檔案大小超過限制 (最大 ${formatFileSize(AppConfig.maxFileSize)})`, 'error');
                    return;
                }
                
                // 開始上傳流程
                startUpload();
            }
            
            /**
             * 開始上傳流程
             */
            function startUpload() {
                // 設定上傳狀態
                AppState.isUploading = true;
                
                // 重置介面
                resetAlerts();
                UI.uploadBtn.disabled = true;
                UI.resultSection.style.display = 'none';
                
                // 顯示進度
                UI.progressContainer.style.display = 'block';
                updateProgress(0, '正在準備上傳...');
                
                // 讀取檔案
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    uploadFileViaForm(AppState.selectedFile, e.target.result);
                };
                
                reader.onerror = function() {
                    handleUploadError('讀取檔案時發生錯誤');
                };
                
                reader.readAsDataURL(AppState.selectedFile);
            }

/**
             * 實現多通道通信的檔案上傳函數
             * @param {File} file - 要上傳的檔案
             * @param {string} fileData - 檔案的Base64編碼資料
             */
            function uploadFileViaForm(file, fileData) {
                // 重置上傳狀態
                resetUploadState();
                
                // 顯示上傳進度
                startProgressSimulation();
                
                // 顯示載入指示器
                UI.loaderContainer.style.display = 'block';
                
                console.log('開始檔案上傳:', file.name);
                
                // 創建上傳ID (增加時間戳和隨機值確保唯一性)
                const randomPart = Math.random().toString(36).substring(2, 10);
                const uploadId = `upload_${new Date().getTime()}_${randomPart}`;
                
                // 保存當前上傳ID
                AppState.currentUploadId = uploadId;
                
                // 存儲上傳信息到本地存儲
                const uploadInfo = {
                    id: uploadId,
                    fileName: file.name,
                    fileType: file.type || 'application/octet-stream',
                    fileSize: file.size,
                    timestamp: new Date().toISOString(),
                    status: 'pending' // 添加狀態跟踪
                };
                
                localStorage.setItem(AppConfig.storageKeys.currentUpload, JSON.stringify(uploadInfo));
                
                // 準備上傳數據
                const uploadData = {
                    fileName: file.name,
                    fileType: file.type || 'application/octet-stream',
                    fileData: fileData,
                    timestamp: new Date().toISOString()
                };
                
                // 創建表單
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = AppConfig.apiUrl;
                
                // 添加JSON數據作為隱藏輸入
                const dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.name = 'data';
                dataInput.value = JSON.stringify(uploadData);
                form.appendChild(dataInput);
                
                // 添加返回URL參數 (增加通信令牌)
                const returnInput = document.createElement('input');
                returnInput.type = 'hidden';
                returnInput.name = 'return_url';
                returnInput.value = window.location.origin + window.location.pathname + 
                                `?upload_success=true&id=${uploadId}&token=${randomPart}`;
                form.appendChild(returnInput);
                
                // 添加來源網址參數 (新增)
                const originInput = document.createElement('input');
                originInput.type = 'hidden';
                originInput.name = 'origin_url';
                originInput.value = window.location.origin;
                form.appendChild(originInput);
                
                // 設置提交目標為新窗口
                const windowName = 'upload_window_' + uploadId;
                form.target = windowName;
                
                // 添加表單到DOM
                document.body.appendChild(form);
                
                // 打開一個窗口來接收表單提交
                let uploadWindow;
                try {
                    uploadWindow = window.open('about:blank', windowName, 'width=400,height=200');
                    
                    // 確保窗口成功打開
                    if (!uploadWindow || uploadWindow.closed || typeof uploadWindow.closed === 'undefined') {
                        throw new Error('彈出窗口被阻擋');
                    }
                } catch (e) {
                    // 彈出窗口被阻擋時的處理
                    handleUploadError('無法打開上傳窗口，請檢查瀏覽器是否阻擋彈出窗口: ' + e.message);
                    document.body.removeChild(form);
                    return;
                }
                
                // 提交表單
                try {
                    form.submit();
                } catch (e) {
                    handleUploadError('表單提交失敗: ' + e.message);
                    if (uploadWindow) uploadWindow.close();
                    document.body.removeChild(form);
                    return;
                }
                
                // 提交後移除表單
                setTimeout(() => {
                    document.body.removeChild(form);
                }, 100);
                
                // 實現多重通信渠道 - 主動輪詢機制
                implementPollingMechanism(uploadId, uploadWindow);
            }
            
            /**
             * 實現主動輪詢機制
             * @param {string} uploadId - 上傳ID
             * @param {Window} uploadWindow - 上傳窗口對象
             */
            function implementPollingMechanism(uploadId, uploadWindow) {
                // 清除任何現有計時器
                clearExistingTimers();
                
                // 設定變數
                const pollInterval = AppConfig.pollingInterval;
                const maxPollDuration = AppConfig.maxPollDuration;
                const maxPollAttempts = Math.floor(maxPollDuration / pollInterval);
                
                let pollCount = 0;
                let uploadDetected = false;
                
                // 首次輪詢前的延遲 (等待上傳開始)
                setTimeout(() => {
                    // 開始輪詢
                    AppState.uploadCheckTimer = setInterval(() => {
                        // 檢查是否達到最大嘗試次數
                        if (pollCount >= maxPollAttempts) {
                            clearPollingAndProcessTimeout(uploadId, uploadWindow);
                            return;
                        }
                        
                        pollCount++;
                        
                        // 首先檢查URL參數 (最直接的成功指標)
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('upload_success') === 'true' && urlParams.get('id') === uploadId) {
                            // URL參數已更新，表示成功
                            const fileUrl = urlParams.get('fileUrl') || '#';
                            clearPollingAndProcessSuccess(uploadId, fileUrl);
                            return;
                        }
                        
                        // 檢查窗口是否已關閉
                        if (uploadWindow && uploadWindow.closed) {
                            // 窗口關閉後，檢查 localStorage 是否有上傳結果通知
                            const storageKey = "uploadResult_" + uploadId;
                            try {
                                const result = JSON.parse(localStorage.getItem(storageKey));
                                if (result && result.status === 'success' && result.fileUrl) {
                                    // 清除結果記錄
                                    localStorage.removeItem(storageKey);
                                    // 處理成功
                                    clearPollingAndProcessSuccess(uploadId, result.fileUrl);
                                    return;
                                } else if (result && result.status === 'error') {
                                    // 清除結果記錄
                                    localStorage.removeItem(storageKey);
                                    // 處理錯誤
                                    clearPollingAndProcessError(uploadId, result.message || '上傳失敗');
                                    return;
                                }
                            } catch (e) {
                                console.warn('檢查本地儲存結果時出錯:', e);
                            }
                            
                            // 如果沒有找到結果，主動查詢上傳狀態
                            activelyCheckUploadStatus(uploadId, (success, fileUrl) => {
                                if (success) {
                                    clearPollingAndProcessSuccess(uploadId, fileUrl);
                                } else if (uploadDetected) {
                                    // 如果之前已檢測到上傳進行中但現在失敗，判定為上傳中斷
                                    clearPollingAndProcessError(uploadId, '上傳過程被中斷');
                                } else {
                                    // 視為用戶取消
                                    clearPollingAndProcessError(uploadId, '上傳已取消');
                                }
                            });
                            return;
                        }
                        
                        // 窗口仍然打開，繼續等待
                        console.log(`輪詢上傳狀態 (${pollCount}/${maxPollAttempts})...`);
                        updateProgress(
                            Math.min(90, 30 + (pollCount / maxPollAttempts) * 60),
                            '處理中...'
                        );
                    }, pollInterval);
                }, 5000); // 5秒後開始輪詢
            }

/**
             * 主動檢查上傳狀態
             * @param {string} uploadId - 上傳ID
             * @param {function} callback - 結果回調函數，參數為(成功狀態, 檔案URL)
             */
            function activelyCheckUploadStatus(uploadId, callback) {
                // 獲取當前上傳信息
                const uploadInfo = JSON.parse(localStorage.getItem(AppConfig.storageKeys.currentUpload)) || {};
                if (!uploadInfo || uploadInfo.id !== uploadId) {
                    callback(false);
                    return;
                }
                
                // 直接檢查本地存儲的狀態
                if (uploadInfo.status === 'completed' && uploadInfo.fileUrl) {
                    callback(true, uploadInfo.fileUrl);
                    return;
                }
                
                // 如果沒有完成狀態，執行JSONP請求檢查
                const callbackName = 'statusCheck_' + Math.random().toString(36).substring(2, 15);
                
                // 設置全局回調函數
                window[callbackName] = function(response) {
                    try {
                        // API狀態檢查邏輯 - 實際可能需要根據API返回結構調整
                        if (response && response.status === 'active') {
                            // API正常運作，但沒有找到上傳記錄，可能尚未完成
                            callback(false);
                        } else {
                            callback(false);
                        }
                    } catch (e) {
                        console.error('處理狀態檢查時出錯:', e);
                        callback(false);
                    } finally {
                        // 清理回調函數
                        delete window[callbackName];
                    }
                };
                
                // 創建script標籤來執行JSONP請求
                const script = document.createElement('script');
                script.src = `${AppConfig.apiUrl}?callback=${callbackName}&action=status&_nocache=${new Date().getTime()}`;
                
                // 設置超時處理
                const timeoutId = setTimeout(function() {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    console.warn('檢查上傳狀態超時');
                    callback(false);
                    delete window[callbackName];
                }, 5000); // 5秒超時
                
                // 處理加載錯誤
                script.onerror = function() {
                    clearTimeout(timeoutId);
                    console.error('檢查上傳狀態失敗');
                    callback(false);
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                // 處理加載完成
                script.onload = function() {
                    clearTimeout(timeoutId);
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                };
                
                // 添加到DOM以執行請求
                document.body.appendChild(script);
            }
            
            /**
             * 清理輪詢並處理上傳成功
             * @param {string} uploadId - 上傳ID
             * @param {string} [fileUrl] - 檔案URL
             */
            function clearPollingAndProcessSuccess(uploadId, fileUrl) {
                clearExistingTimers();
                
                // 獲取上傳信息
                const uploadInfo = JSON.parse(localStorage.getItem(AppConfig.storageKeys.currentUpload)) || {};
                
                // 更新狀態
                uploadInfo.status = 'completed';
                if (fileUrl) {
                    uploadInfo.fileUrl = fileUrl;
                }
                localStorage.setItem(AppConfig.storageKeys.currentUpload, JSON.stringify(uploadInfo));
                
                // 清除URL參數
                if (window.history && window.history.replaceState) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // 處理上傳成功
                handleUploadSuccess({
                    success: true,
                    fileName: uploadInfo.fileName,
                    fileUrl: fileUrl || (uploadInfo.fileUrl || '#'),
                    message: '檔案上傳成功',
                    timestamp: new Date().toISOString()
                });
            }
            
            /**
             * 清理輪詢並處理上傳錯誤
             * @param {string} uploadId - 上傳ID
             * @param {string} errorMsg - 錯誤消息
             */
            function clearPollingAndProcessError(uploadId, errorMsg) {
                clearExistingTimers();
                
                // 更新存儲狀態
                const uploadInfo = JSON.parse(localStorage.getItem(AppConfig.storageKeys.currentUpload)) || {};
                uploadInfo.status = 'error';
                uploadInfo.errorMessage = errorMsg;
                localStorage.setItem(AppConfig.storageKeys.currentUpload, JSON.stringify(uploadInfo));
                
                // 清除URL參數
                if (window.history && window.history.replaceState) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // 處理上傳錯誤
                handleUploadError(errorMsg);
            }
            
            /**
             * 清理輪詢並處理超時
             * @param {string} uploadId - 上傳ID
             * @param {Window} uploadWindow - 上傳窗口
             */
            function clearPollingAndProcessTimeout(uploadId, uploadWindow) {
                // 清除計時器
                clearExistingTimers();
                
                // 最後一次嘗試檢查上傳結果
                activelyCheckUploadStatus(uploadId, (success, fileUrl) => {
                    if (success) {
                        // 即使超時，但實際上傳成功了
                        clearPollingAndProcessSuccess(uploadId, fileUrl);
                    } else {
                        // 真正的上傳超時
                        clearPollingAndProcessError(uploadId, '上傳處理超時，如果檔案較大，可能仍在後台處理中');
                    }
                });
                
                // 嘗試關閉上傳窗口
                try {
                    if (uploadWindow && !uploadWindow.closed) {
                        uploadWindow.close();
                    }
                } catch (e) {
                    console.warn('關閉上傳窗口失敗:', e);
                }
            }
            
            /**
             * 清除所有現有計時器
             */
            function clearExistingTimers() {
                if (AppState.progressInterval) {
                    clearInterval(AppState.progressInterval);
                    AppState.progressInterval = null;
                }
                
                if (AppState.uploadCheckTimer) {
                    clearInterval(AppState.uploadCheckTimer);
                    AppState.uploadCheckTimer = null;
                }
            }
            
            /**
             * 重置上傳狀態
             */
            function resetUploadState() {
                // 清除任何現有的計時器
                clearExistingTimers();
                
                // 清除URL參數
                if (window.history && window.history.replaceState) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // 重置UI元素
                UI.progressBar.style.width = '0%';
                UI.progressBar.setAttribute('aria-valuenow', 0);
                UI.progressPercentage.textContent = '0%';
                UI.uploadStatusText.textContent = '準備上傳中...';
                
                // 重置應用狀態
                AppState.isUploading = true;
            }

/**
             * 開始上傳進度模擬
             */
            function startProgressSimulation() {
                // 清除已有計時器
                if (AppState.progressInterval) {
                    clearInterval(AppState.progressInterval);
                }
                
                let width = AppConfig.progressSimulation.initialValue;
                
                // 設定進度更新間隔
                AppState.progressInterval = setInterval(function() {
                    if (width >= AppConfig.progressSimulation.maxSimulatedValue) {
                        clearInterval(AppState.progressInterval);
                    } else {
                        width += AppConfig.progressSimulation.incrementStep;
                        updateProgress(width, '上傳中...');
                    }
                }, AppConfig.progressSimulation.intervalTime);
            }
            
            /**
             * 更新進度條
             * @param {number} percent - 進度百分比
             * @param {string} statusText - 狀態文字
             */
            function updateProgress(percent, statusText) {
                UI.progressBar.style.width = percent + '%';
                UI.progressBar.setAttribute('aria-valuenow', percent);
                UI.progressPercentage.textContent = percent + '%';
                
                if (statusText) {
                    UI.uploadStatusText.textContent = statusText;
                }
            }
            
            /**
             * 處理上傳成功
             * @param {Object} data - 成功回應資料
             */
            function handleUploadSuccess(data) {
                // 清除進度模擬
                if (AppState.progressInterval) {
                    clearInterval(AppState.progressInterval);
                }
                
                // 清除上傳檢查計時器
                if (AppState.uploadCheckTimer) {
                    clearInterval(AppState.uploadCheckTimer);
                }
                
                // 完成進度條
                updateProgress(100, '上傳完成！');
                
                // 隱藏載入指示器
                UI.loaderContainer.style.display = 'none';
                
                // 顯示成功訊息
                showAlert('檔案已成功上傳！', 'success');
                
                // 顯示結果區域
                if (data.fileUrl) {
                    UI.resultLink.href = data.fileUrl;
                    UI.resultText.textContent = `您的檔案「${data.fileName || AppState.selectedFile.name}」已成功上傳至 Google Drive。`;
                    UI.resultSection.style.display = 'block';
                }
                
                // 延遲重置 UI
                setTimeout(resetUploadUI, 2000);
                
                // 重設上傳狀態
                AppState.isUploading = false;
                AppState.currentUploadId = null;
            }
            
            /**
             * 處理上傳錯誤
             * @param {string} errorMsg - 錯誤訊息
             */
            function handleUploadError(errorMsg) {
                // 清除進度模擬
                if (AppState.progressInterval) {
                    clearInterval(AppState.progressInterval);
                }
                
                // 清除上傳檢查計時器
                if (AppState.uploadCheckTimer) {
                    clearInterval(AppState.uploadCheckTimer);
                }
                
                // 重置進度條
                updateProgress(0, '上傳失敗');
                
                // 隱藏載入指示器
                UI.loaderContainer.style.display = 'none';
                
                // 顯示錯誤訊息
                showAlert('上傳失敗: ' + errorMsg, 'error');
                
                // 重置 UI
                resetUploadUI();
                
                // 重設上傳狀態
                AppState.isUploading = false;
                AppState.currentUploadId = null;
            }
            
            /**
             * 重置上傳 UI
             */
            function resetUploadUI() {
                UI.uploadBtn.disabled = false;
                UI.progressContainer.style.display = 'none';
                UI.fileInput.value = '';
            }
            
            /**
             * 顯示提示訊息
             * @param {string} message - 提示訊息內容
             * @param {string} type - 提示類型 ('success' 或 'error')
             */
            function showAlert(message, type) {
                resetAlerts();
                
                if (type === 'success') {
                    UI.successMessage.textContent = message;
                    UI.successAlert.style.display = 'block';
                    
                    // 自動隱藏成功訊息
                    setTimeout(() => {
                        UI.successAlert.style.display = 'none';
                    }, AppConfig.alertDisplayTime);
                } else {
                    UI.errorMessage.textContent = message;
                    UI.errorAlert.style.display = 'block';
                }
            }
            
            /**
             * 重置所有提示訊息
             */
            function resetAlerts() {
                UI.successAlert.style.display = 'none';
                UI.errorAlert.style.display = 'none';
            }
            
            // 初始化應用程式
            document.addEventListener('DOMContentLoaded', initializeApp);
        })();
    </script>
</body>
</html>
